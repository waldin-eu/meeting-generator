<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waldin Jitsi Link Generator</title>
  <link rel="stylesheet" href="./assets/css/main.css" />
</head>
<body>
  <main class="wrap">
    <h1>Waldin Jitsi link generator</h1>
    <p class="muted">
      Generates a <code>meet.jit.si</code> room named <code>waldinDDMMYYYYHHMM</code> (24h).
    </p>

    <div class="card">
      <div class="row">
        <label>
          Date
          <div class="date-picker" id="datePicker">
            <input id="date" type="hidden" />
            <button type="button" class="date-toggle" id="dateToggle" aria-haspopup="dialog" aria-expanded="false">Select date</button>
            <div class="date-menu" id="dateMenu" hidden>
              <div class="date-header">
                <button type="button" class="date-nav" id="datePrev" aria-label="Previous month">&lt;</button>
                <div class="date-title" id="dateTitle"></div>
                <button type="button" class="date-nav" id="dateNext" aria-label="Next month">&gt;</button>
              </div>
              <div class="date-weekdays" id="dateWeekdays"></div>
              <div class="date-grid" id="dateGrid"></div>
            </div>
          </div>
        </label>

        <label>
          Time (24h)
          <div class="time-picker" id="timePicker">
            <input id="time" type="hidden" />
            <button type="button" class="time-toggle" id="timeToggle" aria-haspopup="listbox" aria-expanded="false">Select time</button>
            <ul class="time-menu" id="timeMenu" role="listbox" hidden></ul>
          </div>
        </label>

        <label>
          Duration (minutes)
          <select id="duration">
            <option value="30">30</option>
            <option value="45">45</option>
            <option value="60" selected>60</option>
            <option value="90">90</option>
            <option value="120">120</option>
          </select>
        </label>

        <button class="primary" id="generate">Generate</button>
      </div>

      <div id="status" class="muted status"></div>

      <div id="result" class="output" style="display:none;">
        <div><strong>Meeting ID:</strong> <span id="meetingId"></span></div>
        <div class="result-link"><strong>Link:</strong> <a id="meetingLink" href="#" target="_blank" rel="noopener"></a></div>

        <div class="actions">
          <button id="copy">Copy link</button>
          <button id="google">Add to Google Calendar</button>
          <button id="ics">Download .ics</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---- helpers ----
    const pad2 = (n) => String(n).padStart(2, "0");
    const TIME_STEP_MINUTES = 15;
    const WEEKDAY_LABELS = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
    const MONTH_FORMATTER = new Intl.DateTimeFormat(undefined, { month: "long", year: "numeric" });

    function formatDDMMYYYY(dateObj) {
      const dd = pad2(dateObj.getDate());
      const mm = pad2(dateObj.getMonth() + 1);
      const yyyy = dateObj.getFullYear();
      return `${dd}${mm}${yyyy}`;
    }

    function formatDisplayDate(dateObj) {
      return dateObj.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
    }

    function buildMeetingId(dateStr, timeStr) {
      // dateStr: YYYY-MM-DD, timeStr: HH:MM
      const [yyyy, mm, dd] = dateStr.split("-").map(Number);
      const [HH, MM] = timeStr.split(":").map(Number);

      // Construct local date (user timezone)
      const d = new Date(yyyy, mm - 1, dd, HH, MM, 0, 0);
      const ddmmyyyy = formatDDMMYYYY(d);
      return `waldin${ddmmyyyy}${pad2(HH)}${pad2(MM)}`;
    }

    function toICSDateUTC(dateObj) {
      // YYYYMMDDTHHMMSSZ in UTC
      const y = dateObj.getUTCFullYear();
      const m = pad2(dateObj.getUTCMonth() + 1);
      const d = pad2(dateObj.getUTCDate());
      const hh = pad2(dateObj.getUTCHours());
      const mm = pad2(dateObj.getUTCMinutes());
      const ss = pad2(dateObj.getUTCSeconds());
      return `${y}${m}${d}T${hh}${mm}${ss}Z`;
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function openDateMenu() {
      dateMenuEl.hidden = false;
      dateToggleEl.setAttribute("aria-expanded", "true");
    }

    function closeDateMenu() {
      dateMenuEl.hidden = true;
      dateToggleEl.setAttribute("aria-expanded", "false");
    }

    function setDateValue(dateStr) {
      dateEl.value = dateStr;
      const [year, month, day] = dateStr.split("-").map(Number);
      const selected = new Date(year, month - 1, day);
      displayedMonth = new Date(year, month - 1, 1);
      dateToggleEl.textContent = formatDisplayDate(selected);
      renderDateMenu();
    }

    function renderDateMenu() {
      dateTitleEl.textContent = MONTH_FORMATTER.format(displayedMonth);
      dateWeekdaysEl.innerHTML = "";
      dateGridEl.innerHTML = "";

      for (const label of WEEKDAY_LABELS) {
        const el = document.createElement("div");
        el.textContent = label;
        dateWeekdaysEl.appendChild(el);
      }

      const startWeekday = new Date(displayedMonth.getFullYear(), displayedMonth.getMonth(), 1).getDay();
      const daysInMonth = new Date(displayedMonth.getFullYear(), displayedMonth.getMonth() + 1, 0).getDate();
      const [selYear, selMonth, selDay] = dateEl.value ? dateEl.value.split("-").map(Number) : [null, null, null];

      for (let i = 0; i < startWeekday; i += 1) {
        const spacer = document.createElement("div");
        spacer.className = "date-empty";
        dateGridEl.appendChild(spacer);
      }

      for (let day = 1; day <= daysInMonth; day += 1) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "date-day";
        btn.textContent = String(day);
        const iso = `${displayedMonth.getFullYear()}-${pad2(displayedMonth.getMonth() + 1)}-${pad2(day)}`;
        btn.dataset.value = iso;
        if (selYear === displayedMonth.getFullYear() && selMonth === (displayedMonth.getMonth() + 1) && selDay === day) {
          btn.classList.add("is-active");
        }
        btn.addEventListener("click", () => {
          setDateValue(iso);
          closeDateMenu();
        });
        dateGridEl.appendChild(btn);
      }
    }

    function closeTimeMenu() {
      timeMenuEl.hidden = true;
      timeToggleEl.setAttribute("aria-expanded", "false");
    }

    function openTimeMenu() {
      timeMenuEl.hidden = false;
      timeToggleEl.setAttribute("aria-expanded", "true");

      const activeEl = timeMenuEl.querySelector(".time-option.is-active");
      if (activeEl) activeEl.scrollIntoView({ block: "nearest" });
    }

    function setTimeValue(timeStr) {
      timeEl.value = timeStr;
      timeToggleEl.textContent = timeStr;

      for (const optionEl of timeMenuEl.querySelectorAll(".time-option")) {
        optionEl.classList.toggle("is-active", optionEl.dataset.value === timeStr);
      }
    }

    function populateTimeOptions(stepMinutes = TIME_STEP_MINUTES) {
      timeMenuEl.innerHTML = "";

      for (let total = 0; total < 24 * 60; total += stepMinutes) {
        const HH = pad2(Math.floor(total / 60));
        const MM = pad2(total % 60);
        const value = `${HH}:${MM}`;
        const listItem = document.createElement("li");
        const optionButton = document.createElement("button");
        optionButton.type = "button";
        optionButton.className = "time-option";
        optionButton.dataset.value = value;
        optionButton.setAttribute("role", "option");
        optionButton.textContent = value;
        optionButton.addEventListener("click", () => {
          setTimeValue(value);
          closeTimeMenu();
        });
        listItem.appendChild(optionButton);
        timeMenuEl.appendChild(listItem);
      }
    }

    function setDefaultNowPlus(minutesAhead = 30) {
      const now = new Date();
      const rounded = new Date(now.getTime());
      rounded.setMinutes(rounded.getMinutes() + minutesAhead);
      rounded.setSeconds(0, 0);

      // Round minutes to match dropdown increments.
      const m = rounded.getMinutes();
      const roundedM = Math.ceil(m / TIME_STEP_MINUTES) * TIME_STEP_MINUTES;
      rounded.setMinutes(roundedM);

      const yyyy = rounded.getFullYear();
      const mm = pad2(rounded.getMonth() + 1);
      const dd = pad2(rounded.getDate());
      const HH = pad2(rounded.getHours());
      const MM = pad2(rounded.getMinutes());

      setDateValue(`${yyyy}-${mm}-${dd}`);
      setTimeValue(`${HH}:${MM}`);
    }

    // ---- main ----
    const dateEl = document.getElementById("date");
    const datePickerEl = document.getElementById("datePicker");
    const dateToggleEl = document.getElementById("dateToggle");
    const dateMenuEl = document.getElementById("dateMenu");
    const datePrevEl = document.getElementById("datePrev");
    const dateNextEl = document.getElementById("dateNext");
    const dateTitleEl = document.getElementById("dateTitle");
    const dateWeekdaysEl = document.getElementById("dateWeekdays");
    const dateGridEl = document.getElementById("dateGrid");
    const timeEl = document.getElementById("time");
    const timePickerEl = document.getElementById("timePicker");
    const timeToggleEl = document.getElementById("timeToggle");
    const timeMenuEl = document.getElementById("timeMenu");
    const durationEl = document.getElementById("duration");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const meetingIdEl = document.getElementById("meetingId");
    const meetingLinkEl = document.getElementById("meetingLink");
    let displayedMonth = new Date();

    let last = null; // store last generated data

    function generate() {
      const dateStr = dateEl.value;
      const timeStr = timeEl.value;

      if (!dateStr || !timeStr) {
        statusEl.innerHTML = `<span class="warn">Pick a date and time first.</span>`;
        resultEl.style.display = "none";
        return;
      }

      const meetingId = buildMeetingId(dateStr, timeStr);
      const url = `https://meet.jit.si/${encodeURIComponent(meetingId)}`;

      // Build local start/end
      const [yyyy, mm, dd] = dateStr.split("-").map(Number);
      const [HH, MM] = timeStr.split(":").map(Number);
      const startLocal = new Date(yyyy, mm - 1, dd, HH, MM, 0, 0);
      const durationMinutes = parseInt(durationEl.value, 10);
      const endLocal = new Date(startLocal.getTime() + durationMinutes * 60000);

      last = { meetingId, url, startLocal, endLocal, durationMinutes };

      meetingIdEl.textContent = meetingId;
      meetingLinkEl.textContent = url;
      meetingLinkEl.href = url;

      statusEl.innerHTML = `<span class="ok">Ready.</span>`;
      resultEl.style.display = "block";
    }

    document.getElementById("generate").addEventListener("click", generate);

    dateToggleEl.addEventListener("click", (event) => {
      event.stopPropagation();
      if (dateMenuEl.hidden) {
        closeTimeMenu();
        openDateMenu();
      } else {
        closeDateMenu();
      }
    });

    datePrevEl.addEventListener("click", (event) => {
      event.stopPropagation();
      displayedMonth = new Date(displayedMonth.getFullYear(), displayedMonth.getMonth() - 1, 1);
      renderDateMenu();
    });

    dateNextEl.addEventListener("click", (event) => {
      event.stopPropagation();
      displayedMonth = new Date(displayedMonth.getFullYear(), displayedMonth.getMonth() + 1, 1);
      renderDateMenu();
    });

    timeToggleEl.addEventListener("click", (event) => {
      event.stopPropagation();
      if (timeMenuEl.hidden) {
        closeDateMenu();
        openTimeMenu();
      } else {
        closeTimeMenu();
      }
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof Node)) return;
      if (!timePickerEl.contains(target)) closeTimeMenu();
      if (!datePickerEl.contains(target)) closeDateMenu();
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeTimeMenu();
        closeDateMenu();
      }
    });

    document.getElementById("copy").addEventListener("click", async () => {
      if (!last) return;
      try {
        await navigator.clipboard.writeText(last.url);
        statusEl.innerHTML = `<span class="ok">Copied to clipboard.</span>`;
      } catch {
        // Fallback
        const tmp = document.createElement("textarea");
        tmp.value = last.url;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        tmp.remove();
        statusEl.innerHTML = `<span class="ok">Copied to clipboard.</span>`;
      }
    });

    document.getElementById("google").addEventListener("click", () => {
      if (!last) return;
      const title = encodeURIComponent(`Waldin Jitsi Meeting`);
      const details = encodeURIComponent(`Join: ${last.url}\nRoom: ${last.meetingId}`);
      const location = encodeURIComponent(last.url);

      // Google Calendar expects dates in UTC or floating; easiest: UTC in YYYYMMDDTHHMMSSZ
      const startUTC = toICSDateUTC(new Date(last.startLocal));
      const endUTC = toICSDateUTC(new Date(last.endLocal));
      const dates = `${startUTC}/${endUTC}`;

      const gcal = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&location=${location}&dates=${dates}`;
      window.open(gcal, "_blank", "noopener,noreferrer");
    });

    document.getElementById("ics").addEventListener("click", () => {
      if (!last) return;

      const uid = `${last.meetingId}@meet.jit.si`;
      const dtstamp = toICSDateUTC(new Date());
      const dtstart = toICSDateUTC(new Date(last.startLocal));
      const dtend = toICSDateUTC(new Date(last.endLocal));

      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Waldin//Jitsi Link Generator//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:Waldin Jitsi Meeting
DESCRIPTION:Join: ${last.url}\\nRoom: ${last.meetingId}
LOCATION:${last.url}
END:VEVENT
END:VCALENDAR`;

      const safeName = last.meetingId.replace(/[^a-zA-Z0-9:_-]/g, "_");
      download(`${safeName}.ics`, ics);
      statusEl.innerHTML = `<span class="ok">Downloaded .ics.</span>`;
    });

    // initialize defaults and auto-generate
    populateTimeOptions();
    setDefaultNowPlus(30);
    generate();
  </script>
</body>
</html>
