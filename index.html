<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waldin Jitsi Link Generator</title>
  <link rel="stylesheet" href="./assets/css/main.css" />
</head>
<body>
  <main class="wrap">
    <h1>Waldin Jitsi link generator</h1>
    <p class="muted">
      Generates a <code>meet.jit.si</code> room named <code>waldinDDMMYYYYHH:MM</code> (24h).
    </p>

    <div class="card">
      <div class="row">
        <label>
          Date
          <input id="date" type="date" />
        </label>

        <label>
          Time (24h)
          <select id="time"></select>
        </label>

        <label>
          Duration (minutes)
          <select id="duration">
            <option value="30">30</option>
            <option value="45">45</option>
            <option value="60" selected>60</option>
            <option value="90">90</option>
            <option value="120">120</option>
          </select>
        </label>

        <button class="primary" id="generate">Generate</button>
      </div>

      <div id="status" class="muted status"></div>

      <div id="result" class="output" style="display:none;">
        <div><strong>Meeting ID:</strong> <span id="meetingId"></span></div>
        <div class="result-link"><strong>Link:</strong> <a id="meetingLink" href="#" target="_blank" rel="noopener"></a></div>

        <div class="actions">
          <button id="copy">Copy link</button>
          <button id="google">Add to Google Calendar</button>
          <button id="ics">Download .ics</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---- helpers ----
    const pad2 = (n) => String(n).padStart(2, "0");
    const TIME_STEP_MINUTES = 15;

    function formatDDMMYYYY(dateObj) {
      const dd = pad2(dateObj.getDate());
      const mm = pad2(dateObj.getMonth() + 1);
      const yyyy = dateObj.getFullYear();
      return `${dd}${mm}${yyyy}`;
    }

    function buildMeetingId(dateStr, timeStr) {
      // dateStr: YYYY-MM-DD, timeStr: HH:MM
      const [yyyy, mm, dd] = dateStr.split("-").map(Number);
      const [HH, MM] = timeStr.split(":").map(Number);

      // Construct local date (user timezone)
      const d = new Date(yyyy, mm - 1, dd, HH, MM, 0, 0);
      const ddmmyyyy = formatDDMMYYYY(d);
      return `waldin${ddmmyyyy}${pad2(HH)}:${pad2(MM)}`;
    }

    function toICSDateUTC(dateObj) {
      // YYYYMMDDTHHMMSSZ in UTC
      const y = dateObj.getUTCFullYear();
      const m = pad2(dateObj.getUTCMonth() + 1);
      const d = pad2(dateObj.getUTCDate());
      const hh = pad2(dateObj.getUTCHours());
      const mm = pad2(dateObj.getUTCMinutes());
      const ss = pad2(dateObj.getUTCSeconds());
      return `${y}${m}${d}T${hh}${mm}${ss}Z`;
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function populateTimeOptions(stepMinutes = TIME_STEP_MINUTES) {
      const timeSelect = document.getElementById("time");
      timeSelect.innerHTML = "";

      for (let total = 0; total < 24 * 60; total += stepMinutes) {
        const HH = pad2(Math.floor(total / 60));
        const MM = pad2(total % 60);
        const option = document.createElement("option");
        option.value = `${HH}:${MM}`;
        option.textContent = `${HH}:${MM}`;
        timeSelect.appendChild(option);
      }
    }

    function setDefaultNowPlus(minutesAhead = 30) {
      const now = new Date();
      const rounded = new Date(now.getTime());
      rounded.setMinutes(rounded.getMinutes() + minutesAhead);
      rounded.setSeconds(0, 0);

      // Round minutes to match dropdown increments.
      const m = rounded.getMinutes();
      const roundedM = Math.ceil(m / TIME_STEP_MINUTES) * TIME_STEP_MINUTES;
      rounded.setMinutes(roundedM);

      const yyyy = rounded.getFullYear();
      const mm = pad2(rounded.getMonth() + 1);
      const dd = pad2(rounded.getDate());
      const HH = pad2(rounded.getHours());
      const MM = pad2(rounded.getMinutes());

      document.getElementById("date").value = `${yyyy}-${mm}-${dd}`;
      document.getElementById("time").value = `${HH}:${MM}`;
    }

    // ---- main ----
    const dateEl = document.getElementById("date");
    const timeEl = document.getElementById("time");
    const durationEl = document.getElementById("duration");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const meetingIdEl = document.getElementById("meetingId");
    const meetingLinkEl = document.getElementById("meetingLink");

    let last = null; // store last generated data

    function generate() {
      const dateStr = dateEl.value;
      const timeStr = timeEl.value;

      if (!dateStr || !timeStr) {
        statusEl.innerHTML = `<span class="warn">Pick a date and time first.</span>`;
        resultEl.style.display = "none";
        return;
      }

      const meetingId = buildMeetingId(dateStr, timeStr);
      const url = `https://meet.jit.si/${encodeURIComponent(meetingId)}`;

      // Build local start/end
      const [yyyy, mm, dd] = dateStr.split("-").map(Number);
      const [HH, MM] = timeStr.split(":").map(Number);
      const startLocal = new Date(yyyy, mm - 1, dd, HH, MM, 0, 0);
      const durationMinutes = parseInt(durationEl.value, 10);
      const endLocal = new Date(startLocal.getTime() + durationMinutes * 60000);

      last = { meetingId, url, startLocal, endLocal, durationMinutes };

      meetingIdEl.textContent = meetingId;
      meetingLinkEl.textContent = url;
      meetingLinkEl.href = url;

      statusEl.innerHTML = `<span class="ok">Ready.</span>`;
      resultEl.style.display = "block";
    }

    document.getElementById("generate").addEventListener("click", generate);

    document.getElementById("copy").addEventListener("click", async () => {
      if (!last) return;
      try {
        await navigator.clipboard.writeText(last.url);
        statusEl.innerHTML = `<span class="ok">Copied to clipboard.</span>`;
      } catch {
        // Fallback
        const tmp = document.createElement("textarea");
        tmp.value = last.url;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        tmp.remove();
        statusEl.innerHTML = `<span class="ok">Copied to clipboard.</span>`;
      }
    });

    document.getElementById("google").addEventListener("click", () => {
      if (!last) return;
      const title = encodeURIComponent(`Waldin Jitsi Meeting`);
      const details = encodeURIComponent(`Join: ${last.url}\nRoom: ${last.meetingId}`);
      const location = encodeURIComponent(last.url);

      // Google Calendar expects dates in UTC or floating; easiest: UTC in YYYYMMDDTHHMMSSZ
      const startUTC = toICSDateUTC(new Date(last.startLocal));
      const endUTC = toICSDateUTC(new Date(last.endLocal));
      const dates = `${startUTC}/${endUTC}`;

      const gcal = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&location=${location}&dates=${dates}`;
      window.open(gcal, "_blank", "noopener,noreferrer");
    });

    document.getElementById("ics").addEventListener("click", () => {
      if (!last) return;

      const uid = `${last.meetingId}@meet.jit.si`;
      const dtstamp = toICSDateUTC(new Date());
      const dtstart = toICSDateUTC(new Date(last.startLocal));
      const dtend = toICSDateUTC(new Date(last.endLocal));

      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Waldin//Jitsi Link Generator//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:Waldin Jitsi Meeting
DESCRIPTION:Join: ${last.url}\\nRoom: ${last.meetingId}
LOCATION:${last.url}
END:VEVENT
END:VCALENDAR`;

      const safeName = last.meetingId.replace(/[^a-zA-Z0-9:_-]/g, "_");
      download(`${safeName}.ics`, ics);
      statusEl.innerHTML = `<span class="ok">Downloaded .ics.</span>`;
    });

    // initialize defaults and auto-generate
    populateTimeOptions();
    setDefaultNowPlus(30);
    generate();
  </script>
</body>
</html>
